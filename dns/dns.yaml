apiVersion: v1
kind: Namespace
metadata:
  name: dns
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: bind9
  namespace: dns
  labels:
    app.kubernetes.io/instance: bind9
    app.kubernetes.io/name: bind9
    app.kubernetes.io/version: 9.18-22.04_beta
data:
  named.conf.options: |
    acl internal {
      10.0.0.0/8;
      172.16.0.0/12;
      192.168.0.0/16;
      localhost;
      localnets;
    };

    options {
      directory "/var/cache/bind";

      # Forwarders configuration
      forwarders {
        8.8.8.8;
        8.8.4.4;
      };
      forward only;

      # Network configuration
      listen-on port 53 { any; };
      listen-on-v6 { none; };
      allow-query { internal; };
      allow-recursion { internal; };
      allow-query-cache { internal; };

      # Performance tuning
      max-cache-size 256m;
      max-cache-ttl 86400;
      max-ncache-ttl 3600;
      recursive-clients 3000;
      tcp-clients 2000;

      # Security settings
      version "not disclosed";
      dnssec-validation auto;
      auth-nxdomain no;
      empty-zones-enable yes;

      # Rate limiting to prevent DNS amplification attacks
      rate-limit {
        responses-per-second 20;
        window 5;
      };

      # Memory and transfer tuning
      transfer-format many-answers;
      transfers-in 10;
      transfers-out 10;
      transfers-per-ns 2;
    };

    # Statistics configuration
    statistics-channels {
      inet 127.0.0.1 port 8053 allow { 127.0.0.1; };
    };

    # Logging configuration
    logging {
      channel default_log {
        file "/var/log/named/default.log" versions 3 size 20m;
        severity info;
        print-time yes;
        print-severity yes;
        print-category yes;
      };

      channel query_log {
        file "/var/log/named/query.log" versions 3 size 20m;
        severity info;
        print-time yes;
      };

      category default { default_log; };
      category queries { query_log; };
    };

  named.conf.local: |
    key "externaldns-key" {
        algorithm hmac-sha256;
        secret "0Z/s3fhefz8Kq3xHNOYaiEvBHsdxEsRMyEx29b5SBLY=";
    };

    zone "local.dev" {
        type master;
        file "/var/cache/bind/local.dev.zone";
        allow-transfer { key externaldns-key; };
        update-policy {
            grant externaldns-key zonesub ANY;
        };
    };


  local.dev.zone: |
    $TTL    86400
    @       IN      SOA     local.dev. root.local.dev. (
                            2023111001      ; Serial
                            3600            ; Refresh
                            1800            ; Retry
                            604800          ; Expire
                            86400           ; Minimum TTL
    )
    @       IN      NS      ns.local.dev.
    @       IN      A       127.0.0.1
    ns      IN      A       127.0.0.1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bind9
  namespace: dns
  labels:
    app.kubernetes.io/instance: bind9
    app.kubernetes.io/name: bind9
    app.kubernetes.io/version: 9.18-22.04_beta
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: bind9
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: bind9
        app.kubernetes.io/name: bind9
        app.kubernetes.io/version: 9.18-22.04_beta
    spec:
      containers:
        - name: bind9
          image: "registry.local.dev:5001/ubuntu/bind9:9.18-22.04_beta"
          command: ["/usr/sbin/named"]
          args: ["-g", "-c", "/etc/bind/named.conf"]
          ports:
            - name: dns-tcp
              containerPort: 53
              protocol: TCP
            - name: dns-udp
              containerPort: 53
              protocol: UDP
            - name: stats
              containerPort: 8053
              protocol: TCP
          livenessProbe:
            tcpSocket:
              port: 53
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            tcpSocket:
              port: 53
            initialDelaySeconds: 5
            periodSeconds: 10
          volumeMounts:
            - name: config
              mountPath: /etc/bind/named.conf.options
              subPath: named.conf.options
            - name: config
              mountPath: /etc/bind/named.conf.local
              subPath: named.conf.local
            - name: config
              mountPath: /var/cache/bind/local.dev.zone
              subPath: local.dev.zone
            - name: bind-logs
              mountPath: /var/log/named
        - name: bind-exporter
          image: "registry.local.dev:5001/prometheuscommunity/bind-exporter:v0.6.0"
          args:
            - --bind.stats-groups=server,view
            - --bind.stats-url=http://localhost:8053/
            - --bind.timeout=20s
            - --web.listen-address=:9119
          ports:
            - name: metrics
              containerPort: 9119
      volumes:
        - name: config
          configMap:
            name: bind9
        - name: bind-logs
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: bind9
  namespace: dns
  labels:
    app.kubernetes.io/instance: bind9
    app.kubernetes.io/name: bind9
    app.kubernetes.io/version: 9.18-22.04_beta
spec:
  type: NodePort
  ports:
    - name: dns-udp
      protocol: UDP
      port: 53
      targetPort: 53
      nodePort: 30053
    - name: dns-tcp
      protocol: TCP
      port: 53
      targetPort: 53
      nodePort: 30053
    - name: stats
      protocol: TCP
      port: 8053
      targetPort: 8053
    - name: metrics
      protocol: TCP
      port: 9119
      targetPort: 9119
  selector:
    app.kubernetes.io/name: bind9
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: bind9
  namespace: dns
  labels:
    app.kubernetes.io/instance: bind9
    app.kubernetes.io/name: bind9
    app.kubernetes.io/version: 9.18-22.04_beta
    release: kube-prometheus
spec:
  endpoints:
  - port: metrics
  jobLabel: bind9
  selector:
    matchLabels:
      app.kubernetes.io/name: bind9
